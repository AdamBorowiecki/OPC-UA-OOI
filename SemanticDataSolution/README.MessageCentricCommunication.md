# UA Semantic Data Message Centric Communication

To realize the [*UA Semantic Data*](../SemanticDataSolution#opc-ua-data-processing-outside-the-server) paradigm in practice **UA Data Application** must get access to the data in context of type definition in compliance with the OPC UA *Information Model*. This article summarize the research on architecture of infrastructure supporting access the data using *Message Centric* communication pattern. The proposed architecture is presented in the following figure.

! (![Domain Model] (./Media/MessageCentricCommunication.Domain.png)

The architecture contains the following classes directly involved in the data processing:
1. **UA Data Application** - a program application that processes OPC UA Data available out of band, i.e. without necessity to create OPC UA session
2. OPC **UA Client** - a program application that processes OPC UA Data available over the created OPC UA session using the standard services
3. **UA Server Services** - typical part of any OPC UA server that provides standard services.
4. **Address Space Management** - typical part of any OPC UA server that manages the Nodes in the Address Space

**UA Data Application** is an application program processing the data in the context of the OPC UA metadata outside of the OPC UA server session. In the presented architecture it gets access to the **UA Semantc Data** using the underlying **Transport** supporting networking services compliant with the *Message Centric* communication pattern standardized in the Part 14. As opposed to OPC UA session centric communication the **Transport** by design is not responsible to distribute the type definitions at run time. To realize the **UA Semantc Data** paradigm, therefore, the data send over the network must be decorated with an unique identifier to find the context prepared in advance against the type definition (semantics), e.g. picture to display the data, algorithm to calculate new values, a key to encrypt the message payload, etc. For example **UA Data Application** may be any remote mobile device according to the *Internet of Things* architecture concept interested to publish process data using the remote OPC UA server. It's even possible to connect household appliances, sensors, and other devices to a central application. For example, it could browse message broker (**Transport**) against defined topics like definition that represent data to be published in the *OPC UA Address Space*. For example IEC61850-enabled IEDs that gets digitalized power grid condition data via process bus and merge units.

**UA Server Services** class is an embedded part of any OPC UA server. **UA Server Services** shall be compliant with OPC UA Specification Part 4, i.e. it must be tested against interoperability for selected standard profile. **Address Space Management** is also a typical part of any OPC UA server. It is responsible for creation and management of the OPC UA *Address Space*. Optionally the server *Address Space* could expose *Information Models* defined by companion specifications, organizations and users.

To leverage [processing of the OPC UA Data outside of the OPC UA session](../SemanticDataSolution#opc-ua-data-processing-outside-the-server) using data networking the above mentioned classes shall support *Message Centric* data exchange pattern using a selected underlying network transport. In this case the following additional optional roles may be considered for them:
1.	Data producer: supported by the writer component populating the messages with the locally obtained data and sending them over the underlying network **Transport**
2.	Data consumer: supported by the reader component receiving messages from the network **Transport** and recovering the UA Data from the messages

To promote interoperability it has to be assumed that producers and consumers must be compliant against an industrial standard. It is proposed to meet this requirement applying emerging OPC UA Standard Part 14 PubSub. Possibility of implementation of the *UA Semantic Data* networking according to presented architecture may be recognized as a proof of concept for this standard. Interoperability rules must create a common foundation for:
1. Messages encoding, decoding, and protecting against malicious users
2. Association of the data with the data meaning - semantics

Encoding means that data is represented as a stream of bits according to selected data type, for example long, float, string, structure, etc. Semantic rules can be used to find appropriate semantics context (object type definition) for further processing, for example recognize the data as an output temperature of the boiler.

**UA Server Writer** (data producer role) and **UA Server Reader** (data consumer role) may support out of band interconnection of the nodes exposed in the *Address Space* and applications using *Message Centric* communication pattern. Out of band in the context means that to exchange data the applications do not need establishing session. The data is distributed by transmitting messages over the underlying **Transport**. Data exchange between nodes in the *Address Space* and *Message Centric* environment resembles the data exchange with the underlying process using a field level protocol, for example Modbus. Main difference is that from the process perspective (not shown in the figure above) new value of a *Variable* node is usually injected into the process as a new control value with the purpose to change its behavior. From the networking perspective values representing measurements and control signals are treated equally.

**UA Client Writer** (data producer role) and **UA Client Reader** (data consumer role) associated with the OPC **UA Client** may be used to create a communication bridge between session centric and *Message Centric* environments. In the presented architecture OPC **UA Client**  is the functional class that shall be compliant with OPC UA Specification Part 4. In the bridge scenario additionally data may be converted to different syntax and semantics rules leveraging integration of different Industrial IT systems. Main advantage of this archetype is its passive nature, i.e. a possibility to use it in existing environment.

The **UA Message Writer**  (data producer role) and **UA Message Reader** (data consumer role) writes and reads messages from underlying **Transport**. It is assumed that messages contain current values of the selected *Variable* nodes exposed by an OPC UA server in the *Address Space*. It is worth nothing that in this processing scenario the most important thing is data meaning, i.e. data semantics, but not where the data come from. The **UA Message Reader** by design is responsible to recover this information from the message and match appropriate context for further processing. This operation is called process data binding. To make the data recognizable in context of a definition in the selected OPC UA *Information Model* the **UA Message Writer** by design is responsible to decorate the populated using local data message with definition identifier. Using this information, for example the **UA Server Reader** associates the *Variable* nodes and recovered form the message data.

Main role of the **Transport** layer is to transfer messages containing OPC UA data from source to ultimate destination node. The following communication patterns can be applied:
* publish–subscribe (PubSub): senders of messages, called publishers, do not program the messages to be sent directly to specific receivers (no direct addressing, alternatively topics/threads/Queues are used), called subscribers.
*	forwarding – sender directly address a receiver (unicasting) or receivers (multicasting) of the message. If a receiver has not requested the message in advance it is unsolicited communication.

Simplifying the PubSub pattern resembles RSS, but forwarding resembles email.
